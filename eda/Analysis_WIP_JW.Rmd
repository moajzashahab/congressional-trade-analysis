---
title: "Trade Analysis"
author: "Jerrin Wiley"
date: "`r Sys.Date()`"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

## Load Packages

```{r libraries, warning=FALSE}
# load libraries
library(httr)
library(jsonlite)
library(dplyr)
library(tidyr)
library(tidyquant)
library(naniar)
library(purrr)
library(progressr)
library(here)
library(openxlsx)
library(bizdays)
library(timeDate)
library(ggplot2)
```

## Pre-Processing

### Load Financials

```{r load_financials}
url <- "https://house-stock-watcher-data.s3-us-west-2.amazonaws.com/data/all_transactions.json"
  
response <- GET(url)

disclosure_data_raw <- fromJSON(content(response, as = "text", encoding = "UTF-8"))

head(disclosure_data_raw)
```

### Handle missing values

Create working file with relevant information

```{r preprocessing_createDf}
# Filter disclosure information to relevent features, assuming we are not considering volume of purchase
disclosure_data <- subset(disclosure_data_raw,select=c('representative','party','transaction_date','ticker','type','industry','sector'))
head(disclosure_data)
```

Check for NA's

```{r preprocessing_format_NA}
#Some rows have missing ticker values coded as "--". Convert to NA for cleanup
disclosure_data <- disclosure_data %>%
  mutate(ticker = na_if(ticker, "--"))
```

```{r preprocessing_visualizeNAs}

# Visualize missing data
vis_miss(disclosure_data)
```

```{r remove_NAs}
nbefore <- nrow(disclosure_data)
disclosure_data <- disclosure_data %>%
  filter(!is.na(ticker))
nafter <- nrow(disclosure_data)
nremoved <- nbefore - nafter
cat("n before: ", nbefore, "\nn after: ", nafter,"\n----------------\nn removed: ", nremoved)
```

```{r preprocessing_convert_date_format}
# Convert dates
disclosure_data$transaction_date <- as.Date(disclosure_data$transaction_date)

# View the modified data frame
disclosure_data
```

To speed up processing, lets filter for our target time range

```{r time_filter}
# Change years list for filtering
years <- c("2021","2022")

disclosure_data <- disclosure_data %>%
  filter(format(transaction_date, "%Y") %in% years)
cat("Remaining n: ", nrow(disclosure_data))
```

### Calculate Price Change

Next we need to find the stock value at time of purchase.

```{r}
get_closing_prices <- function(disclosure_data, days_later = 0, price_column_name = "purchase_price") {
  # Ensure transaction_date is in Date format
  disclosure_data <- disclosure_data %>%
    mutate(transaction_date = as.Date(transaction_date))

  # Load necessary packages
  library(bizdays)
  library(timeDate)

  # Get NYSE holidays
  nyse_holidays <- holidayNYSE(2000:2030)

  # Create a trading calendar
  bizdays::create.calendar(
    name = "NYSE",
    holidays = as.Date(nyse_holidays),
    weekdays = c("saturday", "sunday")
  )

  # Adjust transaction_date if it falls on a non-trading day
  disclosure_data <- disclosure_data %>%
    mutate(
      transaction_date = bizdays::adjust.next(transaction_date, "NYSE")
    )

  # Adjust disclosure_data by adding price_date and adjusting to next trading day
  disclosure_data <- disclosure_data %>%
    mutate(
      price_date_unadjusted = transaction_date + days_later,
      price_date = bizdays::adjust.next(price_date_unadjusted, "NYSE")
    )

  # Extract unique tickers and date range from price_date
  tickers <- unique(disclosure_data$ticker)
  date_range <- range(disclosure_data$price_date, na.rm = TRUE)

  # Enable progress bar
  handlers("progress")

  # Fetch prices with progress tracking and error handling
  prices <- with_progress({
    p <- progressor(steps = length(tickers))

    tickers %>%
      map_dfr(~ {
        p(sprintf("Fetching data for %s", .x)) # Update progress

        # Try to get data, skip if ticker not found
        tryCatch(
          {
            tq_get(.x, from = date_range[1], to = date_range[2]) %>%
              select(symbol, date, close)
          },
          error = function(e) {
            warning(sprintf("Ticker %s not found or unavailable.", .x))
            tibble(symbol = .x, date = NA, close = NA)  # Return empty row with NA for unavailable tickers
          }
        )
      })
  })

  # Join the closing prices back to disclosure_data on ticker and price_date
  data_with_prices <- disclosure_data %>%
    left_join(prices, by = c("ticker" = "symbol", "price_date" = "date"))

  # Rename 'close' column to the specified price_column_name
  data_with_prices <- data_with_prices %>%
    rename(!!price_column_name := close)

  # Optionally, drop the 'price_date' and 'price_date_unadjusted' columns if not needed
  # data_with_prices <- data_with_prices %>%
  #   select(-price_date, -price_date_unadjusted)

  print(names(data_with_prices))

  return(data_with_prices)
}
```

```{r retrieve_purchase_price, warning=FALSE}
disclosure_data <- get_closing_prices(disclosure_data, days_later = 0, price_column_name = "purchase_price")
```

```{r retrieve_later_price, warning=FALSE}
disclosure_data <- get_closing_prices(disclosure_data, days_later = 365, price_column_name = "purchase_price_plus_365")
```

```{r remove_price_NAs}
nbefore <- nrow(disclosure_data)
disclosure_data <- disclosure_data %>%
  filter(!is.na(purchase_price))
cat("n before removal: ",nbefore,"\nn after removal: ",nrow(disclosure_data),"\n")
```

```{r data_checkpoint_purchase_price}
# Define the relative path within the repository
output_path <- here("data/disclosure_data.xlsx")

# Write the dataframe to the specified relative path
write.xlsx(disclosure_data, file = output_path)
```

```{r data_restoration}
## Uncomment and use to restore the data checkpoint

#open_path <- here("data/disclosure_data.xlsx")
#disclosure_data <- read.xlsx(xlsxFile = open_path)
#disclosure_data$transaction_date <- as.Date(disclosure_data$transaction_date, origin = "1899-12-30")
```

```{r price_change}
disclosure_data <- disclosure_data %>%
  mutate(price_change = purchase_price_plus_365 - purchase_price)
```

```{r common_traders}
# Step 1: Find the top 10 most common tickers
top_traders <- disclosure_data %>%
  count(representative) %>%
  arrange(desc(n)) %>%
  slice_head(n = 10) %>%
  pull(representative)  # Extract the representative names

# Step 2: Calculate counts and proportions for each type within top 10 tickers
prevalence_by_type <- disclosure_data %>%
  filter(representative %in% top_traders) %>%       # Filter for top 10 tickers
  count(representative, type) %>%                   # Count occurrences by representative and type
  pivot_wider(names_from = type,            # Spread types into columns
              values_from = n, 
              values_fill = 0) %>%          # Fill missing types with 0
  mutate(total = rowSums(select(., -representative))) %>%  # Calculate total count for each representative
  relocate(total, .after = representative) %>%      # Move total to be the second column
  arrange(desc(total))                      # Sort by total in descending order

# Display the result
prevalence_by_type
```

```{r common_tickers}
# Step 1: Find the top 10 most common tickers
top_tickers <- disclosure_data %>%
  count(ticker) %>%
  arrange(desc(n)) %>%
  slice_head(n = 10) %>%
  pull(ticker)  # Extract the ticker names

# Step 2: Calculate counts and proportions for each type within top 10 tickers
prevalence_by_type <- disclosure_data %>%
  filter(ticker %in% top_tickers) %>%       # Filter for top 10 tickers
  count(ticker, type) %>%                   # Count occurrences by ticker and type
  pivot_wider(names_from = type,            # Spread types into columns
              values_from = n, 
              values_fill = 0) %>%          # Fill missing types with 0
  mutate(total = rowSums(select(., -ticker))) %>%  # Calculate total count for each ticker
  relocate(total, .after = ticker) %>%      # Move total to be the second column
  arrange(desc(total))                      # Sort by total in descending order

# Display the result
prevalence_by_type
```

```{r remove_exchanges}
nbefore <- nrow(disclosure_data)
disclosure_data <- disclosure_data %>%
  filter(!(type == 'exchange'))
nafter <- nrow(disclosure_data)
nremoved <- nbefore - nafter
cat("n before: ", nbefore, "\nn after: ", nafter,"\n----------------\nn removed: ", nremoved)
```

```{r price_change_histograms}
# Create the histogram with faceting by 'type'
ggplot(disclosure_data, aes(x = price_change)) +
  geom_histogram(binwidth = 100, fill = "skyblue", color = "black") +
  facet_wrap(~ type) +
  labs(title = "Histogram of Price Change by Type", x = "Price Change", y = "Count") +
  theme_minimal()
```

### Check trader accuracy

Trader accuracy is defined as a purchasing a stock and then the price increased, as well as selling before the price decreases

```{r trade_prediction}
disclosure_data <- disclosure_data %>%
  mutate(prediction = if_else(type == "purchase", "increase", "decrease"))
```

```{r trade_actual}
disclosure_data <- disclosure_data %>%
  mutate(actual = if_else(price_change >= 0, "increase", "decrease"))
```

```{r trade_accuracy}
disclosure_data <- disclosure_data %>%
  mutate(trade_accuracy = if_else(prediction == actual, 1, 0))
```
