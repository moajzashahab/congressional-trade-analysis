---
title: "Trade Analysis"
author: "Jerrin Wiley"
date: "`r Sys.Date()`"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

## Load Packages

```{r libraries, warning=FALSE}
# load libraries
library(httr)
library(jsonlite)
library(dplyr)
library(tidyr)
library(tidyquant)
library(naniar)
library(purrr)
library(progressr)
library(here)
```

## Pre-Processing

### Load Financials

```{r load_financials}
url <- "https://house-stock-watcher-data.s3-us-west-2.amazonaws.com/data/all_transactions.json"
  
response <- GET(url)

disclosure_data_raw <- fromJSON(content(response, as = "text", encoding = "UTF-8"))

head(disclosure_data_raw)
```

### Handle missing values

Create working file with relevant information

```{r preprocessing_createDf}
# Filter disclosure information to relevent features, assuming we are not considering volume of purchase
disclosure_data <- subset(disclosure_data_raw,select=c('representative','party','transaction_date','ticker','type','industry','sector'))
head(disclosure_data)
```

Check for NA's

```{r preprocessing_format_NA}
#Some rows have missing ticker values coded as "--". Convert to NA for cleanup
disclosure_data <- disclosure_data %>%
  mutate(ticker = na_if(ticker, "--"))
```

```{r preprocessing_visualizeNAs}

# Visualize missing data
vis_miss(disclosure_data)
```

```{r remove_NAs}
nbefore <- nrow(disclosure_data)
disclosure_data <- disclosure_data %>%
  filter(!is.na(ticker))
nafter <- nrow(disclosure_data)
nremoved <- nbefore - nafter
cat("n before: ", nbefore, "\nn after: ", nafter,"\n----------------\nn removed: ", nremoved)
```

```{r preprocessing_convert_date_format}
# Convert dates
disclosure_data$transaction_date <- as.Date(disclosure_data$transaction_date)

# View the modified data frame
disclosure_data
```

To speed up processing, lets filter for our target time range

```{r time_filter}
# Change years list for filtering
years <- c("2021","2022")

disclosure_data <- disclosure_data %>%
  filter(format(transaction_date, "%Y") %in% years)
cat("Remaining n: ", nrow(disclosure_data))
```

Next we need to find the stock value at time of purchase.

```{r purchase_price_function}
# Function to retrieve closing prices with error handling and progress bar
get_closing_prices <- function(disclosure_data) {
  # Extract unique tickers and date range
  tickers <- unique(disclosure_data$ticker)
  date_range <- range(disclosure_data$transaction_date, na.rm = TRUE)
  
  # Enable progress bar
  handlers("progress")
  
  # Fetch prices with progress tracking and error handling
  prices <- with_progress({
    p <- progressor(steps = length(tickers))
    
    tickers %>%
      map_dfr(~ {
        p(sprintf("Fetching data for %s", .x)) # Update progress
        
        # Try to get data, skip if ticker not found
        tryCatch(
          {
            tq_get(.x, from = date_range[1], to = date_range[2]) %>%
              select(symbol, date, close)
          },
          error = function(e) {
            warning(sprintf("Ticker %s not found or unavailable.", .x))
            tibble(symbol = .x, date = NA, close = NA)  # Return empty row with NA for unavailable tickers
          }
        )
      })
  })
  
  # Join the closing prices back to data_working
  data_with_prices <- disclosure_data %>%
    left_join(prices, by = c("ticker" = "symbol", "transaction_date" = "date"))
  
  return(data_with_prices)
}
```

```{r retrieve_purchase_price, warning=FALSE}
# Retrieve current price
disclosure_data <- get_closing_prices(disclosure_data)
```

```{r data_checkpoint_purchase_price}
# Define the relative path within the repository
output_path <- here("data/disclosure_data.xlsx")

# Write the dataframe to the specified relative path
write.xlsx(disclosure_data, file = output_path)
```

```{r data_restoration}
## Uncomment and use to restore the data checkpoint

#open_path <- here("data/disclosure_data.xlsx")
#disclosure_data <- read.xlsx(xlsxFile = open_path)
#disclosure_data$transaction_date <- as.Date(disclosure_data$transaction_date, origin = "1899-12-30")
```

```{r remove_price_NAs}
nbefore <- nrow(disclosure_data)
disclosure_data <- disclosure_data %>%
  filter(!is.na(close))
cat("n before removal: ",nbefore,"\nn after removal: ",nrow(disclosure_data),"\n")
```

```{r time_filter}
# Change years list for filtering
years <- c("2021","2022")

disclosure_data <- disclosure_data %>%
  filter(format(transaction_date, "%Y") %in% years)
cat("Remaining n: ", nrow(disclosure_data))
```
